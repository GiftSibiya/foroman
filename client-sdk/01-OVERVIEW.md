# Client SDK Integration - Overview

## What This Is

A template-based system that generates a complete `src/backend/` folder structure for React client applications. This allows external apps to securely access their Skaftin project data with full TypeScript type safety.

## Architecture

```
External React App
├── src/
│   ├── backend/              ← Generated by Skaftin
│   │   ├── client/           → Unified SkaftinClient (NEW - Simplified!)
│   │   │   └── SkaftinClient.ts → Single client for all API interactions
│   │   ├── config/           → API configuration (simplified)
│   │   ├── schemas/          → TypeScript interfaces (from DB)
│   │   ├── services/         → API service methods
│   │   ├── hooks/            → React hooks (WebSocket, etc.)
│   │   ├── types/            → API response types
│   │   └── utils/            → Auth & request helpers (backward compatible)
│   ├── components/           → Your React components
│   └── pages/                → Your React pages
└── .env                       → API credentials
```

### ⭐ New: Unified Client Architecture

The SDK now uses a **unified `SkaftinClient`** that handles:
- ✅ Configuration loading from environment variables
- ✅ Authentication header management
- ✅ All HTTP request methods (GET, POST, PUT, DELETE, etc.)
- ✅ Automatic JWT token injection for app user requests
- ✅ Error handling and logging

**Benefits:**
- Single import: `import { skaftinClient } from './backend'`
- No manual initialization needed
- Cleaner, more maintainable code
- Backward compatible with existing code

## How It Works

### Step 1: Authentication
Client app includes API key or access token in headers:
```typescript
headers: {
  'X-API-Key': 'sk_your_api_key_here'  // Note: Capital X
  // Note: Project ID auto-detected from credential, no need to include separately!
}
```

**Key Improvement:** Project context is now automatically identified from your API key/token, eliminating the need to manually include project IDs in headers or URLs for most endpoints.

### Step 2: Backend Validation
Skaftin backend:
- Validates credential in `api_credentials` table
- Extracts `project_id` from credential
- Identifies organization from project
- Checks permissions (for access tokens)
- Returns project-scoped data

### Step 3: Type-Safe Client
Generated SDK provides multiple ways to interact:

**Option 1: Unified Client (Recommended - New!)**
```typescript
import { skaftinClient } from './backend';

// Direct API calls
// JWT tokens automatically injected from Zustand AuthStore
const response = await skaftinClient.get('/app-api/database/tables/associations/select');
const associations = response.data; // Fully typed!
```

**Option 2: Service Classes (Traditional)**
```typescript
import { AssociationService } from './backend/services';

const associations = await AssociationService.findAll();
// Type: Association[] (fully typed!)
```

Both approaches work - use what fits your needs!

## What Gets Generated

### 1. Schemas (TypeScript Interfaces)
One file per database table:
- Type definitions from columns
- Create/Update DTOs
- Validation types

### 2. Services (API Methods)
Per-table services with methods:
- `findAll()` - Get all records
- `findById(id)` - Get by ID
- `create(data)` - Insert new record
- `update(id, data)` - Update record
- `delete(id)` - Delete record
- `query(options)` - Custom queries

**Plus App User Management:** ⭐ NEW
- `listUsers()` - List app users with filters
- `createUser()` - Register new users
- `assignRole()` - Role assignment
- `listRoles()` - Get available roles
- `createCustomField()` - Add custom user fields

### 3. Configuration
- API URL (development/production)
- Project ID
- Authentication setup
- Environment variable mapping

### 4. Unified Client ⭐ NEW
- `SkaftinClient` - Single class for all API interactions
- Auto-loads configuration from environment
- Handles authentication automatically
- Provides all HTTP methods (get, post, put, delete, etc.)
- Backward compatible with existing utilities

### 5. Utilities (Backward Compatible)
- Auth helper (delegates to client)
- Request wrapper (uses client internally)
- Error handling
- Response parsing

### 5. GraphQL Client
- Query method
- Mutation method
- Typed responses
- Error handling

### 6. WebSocket Service ⭐ NEW
- Real-time database change notifications
- Project-scoped event rooms
- Auto-reconnection handling
- React hooks for easy integration
- Type-safe event handling

## Benefits

✅ **Type Safety** - Full TypeScript typing from database schema  
✅ **Simplified Integration** - Unified client handles everything ⭐ NEW  
✅ **Modular** - One service per table  
✅ **Secure** - API key/token authentication  
✅ **Multi-tenant** - Each credential scoped to one project  
✅ **GraphQL Support** - Alternative to REST  
✅ **Auto-generated** - No manual typing needed  
✅ **Easy Updates** - Regenerate when schema changes  
✅ **User Management** - Complete auth system built-in  
✅ **SuperTokens Integration** - Automatic session management and token refresh ⭐ NEW  
✅ **Zustand AuthStore** - State management for user sessions ⭐ NEW  
✅ **Role-Based Access** - Flexible permission system  
✅ **Custom Fields** - Extend user profiles  
✅ **Real-Time Updates** - WebSocket support for instant notifications  
✅ **Backward Compatible** - Existing code continues to work ⭐ NEW

## Authentication Models

### API Keys (`sk_...`)
- Server-to-server communication
- Full permissions (customizable)
- Long-lived
- For backend services

### Access Tokens (`sat_...`)
- Client applications
- Granular permissions (read/write/delete per resource)
- Can expire
- For frontend apps

### MCP Keys (`mcp_...`)
- AI/MCP integrations only
- Not for client apps
- Full access, never expires

## Multi-Tenant Architecture

Each credential is tied to:
- **One Project** - All queries scoped to project schema
- **One Organization** - Inherited from project
- **Specific Permissions** - What operations allowed

This ensures:
- Data isolation between projects
- Security by default
- Easy scaling
- Clear access control

## Next Steps

Read the following guides in order:
1. `02-AUTHENTICATION.md` - Set up API credentials
2. `03-TYPE-GENERATION.md` - Generate TypeScript types
3. `04-SERVICE-GENERATION.md` - Create API services
4. `05-GRAPHQL-INTEGRATION.md` - Use GraphQL
5. `06-USAGE-EXAMPLES.md` - Real-world examples
6. `07-APP-USER-AUTHENTICATION.md` - App user management ⭐ NEW
7. `08-WEBSOCKET-INTEGRATION.md` - Real-time updates ⭐ NEW

